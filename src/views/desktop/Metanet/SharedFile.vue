<template>
  <div class="w-full h-full" :style="{
    background: '#f0f2f5',
  }">
    <header class="px-12 h-14 mb-6 bg-white flex items-center justify-between">
      <div
        class="flex items-center justify-center cursor-pointer"
        :style="{
          filter: 'drop-shadow(0px 4px 4px rgba(0, 0, 0, 0.25))',
        }"
        @click="onClickLogo"
      >
        <!-- TODO hover effect -->
        <XSvgIcon icon="logo" :size="28" />
      </div>
      <div
        class="flex-1 font-14 text-gray-400 text-center pt-1 flex items-center justify-center relative"
      >
        üìÖ
        <span class="mx-1">{{ insertedAtText }}</span>
        ‚è≥
        {{ expiredText }}
        <!-- Â§öËØ≠Ë®Äicon -->
        <div
          class="absolute-center-y right-4"
          :style="{
            'font-size': '22px',
          }"
        >
          <XLocaleSwither class="cursor-pointer text-gray-600 localeSwitcher" />
        </div>
      </div>
      <div
        v-if="!isUserLoggedIn"
        class="flex-center cursor-pointer text-gray-600"
        @click="onClickUnLoggInUserIcon"
      >
        <XSvgIcon icon="user" :size="26" />
      </div>
      <XUserAvatar v-else class="w-6 h-6" />
    </header>
    <main class="px-20">
      <a-spin :spinning="lockPageLoading">
        <template #indicator>
          <LoadingOutlined />
        </template>
        <div
          class="bg-white rounded-xl"
          :style="{
            'min-height': 'calc(100vh - 200px)',
            padding: 0,
          }"
        >
          <template v-if="!lockPageLoading">
            <!-- Êñá‰ª∂ÊúâÊïà -->
            <template v-if="isValid">
              <template v-if="userPreview.email">
                <!-- ËøòÊ≤°ÈÄöËøáËÆøÈóÆÁ†Å -->
                <div
                  v-if="!isCodeResolved"
                  class="flex flex-col items-center justify-center"
                  :style="{
                    height: 'calc(100vh - 300px)',
                    width: '300px',
                    margin: '0 auto',
                  }"
                >
                  <!-- Â§¥ÂÉè -->
                  <div
                    class="rounded-full w-14 h-14 flex items-center justify-center text-white text-2xl mb-3"
                    :style="{
                      background:
                        'linear-gradient(45deg, rgb(0, 172, 193), rgb(0, 213, 226))',
                    }"
                  >{{ userPreview.username[0].toUpperCase() }}</div>
                  <!-- ÂêçÂ≠ó -->
                  <div class="w-full text-center mb-4 font-semibold">{{ userPreview.username }}</div>
                  <!-- inputcode -->
                  <div class="w-full mb-4">
                    <a-input v-model:value="inputCode" placeholder="ËØ∑ËæìÂÖ•ËÆøÈóÆÁ†Å" />
                  </div>
                  <!-- ÊèêÂèñÊñá‰ª∂ -->
                  <div class="w-full mb-4">
                    <a-button
                      block
                      type="primary"
                      :loading="confirmLoading"
                      @click="onConfirmCode"
                    >ÊèêÂèñÊñá‰ª∂</a-button>
                  </div>
                  <!-- Êñá‰ª∂ÊúâÊïàÊúü -->
                  <div class="w-full text-center font-12 text-gray-400">{{ expiredText }}</div>
                </div>
                <!-- ÈÄöËøáËÆøÈóÆÁ†ÅÊéßÂà∂‰∫Ü -->
                <div v-else>
                  <div
                    class="flex items-center p-3"
                    :style="{
                      'border-bottom': '1px solid #eee',
                    }"
                  >
                    <div
                      class="rounded-full w-10 h-10 flex items-center justify-center text-white text-xl mr-2"
                      :style="{
                        background:
                          'linear-gradient(45deg, rgb(0, 172, 193), rgb(0, 213, 226))',
                      }"
                    >{{ userPreview.username[0].toUpperCase() }}</div>
                    <div class="font-semibold font-16 mr-2">{{ userPreview.username }} Áªô‰Ω†ÂàÜ‰∫´‰∫ÜÊñá‰ª∂</div>
                    <!-- <div class="font-12 text-gray-400 pt-1 flex items-center">
                      üìÖ
                      <span class="mx-1">{{ insertedAtText }}</span>
                      ‚è≥
                      {{ expiredText }}
                    </div>-->
                    <div class="flex-1"></div>
                    <div class="font-22 text-gray-500 px-1 mr-2" @click="onCollectShare">
                      <a-tooltip title="Êî∂Ëóè">
                        <StarFilled v-if="isCurrentShareCollected" :style="{ color: '#faad14' }" />
                        <StarOutlined v-else />
                      </a-tooltip>
                    </div>
                    <div class="font-22 text-gray-500 px-2">
                      <a-tooltip title="ËΩ¨Âèë">
                        <XSvgIcon class="cursor-pointer" icon="share" :size="22" />
                      </a-tooltip>
                    </div>
                  </div>
                  <!-- ÂäüËÉΩÂå∫ -->
                  <div class="pt-3 px-3 mb-3 flex items-center">
                    <!-- Êñá‰ª∂Â§πÁ±ªÂûãÊâçÊòæÁ§∫Ë∑ØÂæÑ -->
                    <!-- <div v-if="isCurrentShareFolder" class="mr-2 flex items-center">
                  <template v-for="(dir, idx) in historyDir" :key="dir.dirId">
                    <a
                      :class="{
                        'text-gray-400': idx === historyDir.length - 1,
                      }"
                      @click="onUpperLevel(idx)"
                    >
                      {{ dir.dirName }}
                    </a>
                    <span
                      v-if="idx !== historyDir.length - 1"
                      class="px-2 text-gray-400"
                      >></span
                    >
                  </template>
                    </div>-->
                    <div
                      ref="fileTableRef"
                      class="flex-1 flex items-center px-3 mr-2"
                      :style="{
                        height: '28px',
                        'border-radius': '50px',
                        'background-color': '#f7f7f8',
                      }"
                    >
                      <a-tooltip title="ÊèèËø∞‰ø°ÊÅØ">
                        <a class="mr-2" href="javascript:;" @click="onShowDescriptionModal">
                          <InfoCircleOutlined />
                        </a>
                      </a-tooltip>
                      <div v-if="isCurrentShareFolder" class="mr-2 flex-1 flex items-center">
                        <template v-for="(dir, idx) in historyDir" :key="dir.dirId">
                          <a
                            :class="{
                              'text-gray-400': idx === historyDir.length - 1,
                            }"
                            @click="onUpperLevel(idx)"
                          >{{ dir.dirName }}</a>
                          <span v-if="idx !== historyDir.length - 1" class="px-2 text-gray-400">></span>
                        </template>
                        <!-- ÁÇπÂáª‰∫ÜÊñá‰ª∂Âêç(ÈùûÊñá‰ª∂Â§π),Âú∞ÂùÄÊ†èÊòæÁ§∫ -->
                        <!-- TODO -->
                        <template v-if="isShowDescriptionModalFileNameInAddressBar">
                          <span class="px-2 text-gray-400">></span>
                          {{ currentDescriptionModalFileName }}
                        </template>
                      </div>
                      <div v-else class="flex-1"></div>
                      <a-tooltip title="ËØÑËÆ∫">
                        <a href="javascript:;" @click="onCommentShare">
                          <EditOutlined />
                        </a>
                      </a-tooltip>
                    </div>
                    <div>
                      <!-- <a-button shape="round" class="mr-2" @click="onCollectShare">
                    <HeartFilled
                      v-if="isCurrentShareCollected"
                      :style="{ color: '#faad14' }"
                    />
                    <HeartOutlined v-else />
                    <span class="text-gray-400">{{
                      curShareCollectedCount
                    }}</span>
                      </a-button>-->
                      <a-button
                        shape="round"
                        :disabled="selectedRowKeys.length === 0"
                        @click="
                          saveToMetanetModalPreAction(
                            selectedRows.map((i) => i.userFile) as TFileItem[]
                          )
                        "
                        class="mr-2"
                      >
                        <ExportOutlined />‰øùÂ≠òÂà∞ÁΩëÁõò
                      </a-button>
                      <a-button
                        shape="round"
                        :disabled="selectedRowKeys.length === 0"
                        class="mr-2"
                        @click="onBatchDownload"
                      >
                        <DownloadOutlined />‰∏ãËΩΩ
                      </a-button>
                      <a-button
                        shape="round"
                        :disabled="selectedRowKeys.length === 0"
                        @click="onZipDownload"
                      >
                        <XSvgIcon icon="zip" :size="14" />
                        <span>ÂéãÁº©‰∏ãËΩΩ</span>
                      </a-button>
                      <!-- <a-button
                    shape="round"
                    :disabled="selectedRowKeys.length === 0"
                    @click="onBatchScore"
                  >
                    <HighlightOutlined />
                    ËØÑ‰ª∑
                      </a-button>-->
                    </div>
                  </div>
                  <!-- Ë°®Ê†ºÂå∫ -->
                  <XTableFiles
                    class="px-3"
                    rowKey="id"
                    :columns="columns"
                    :data="fileData"
                    :loading="isLoadingListData"
                    v-model:selectedRows="selectedRows"
                    v-model:selectedRowKeys="selectedRowKeys"
                  >
                    <template #name="{ record }">
                      <div class="relative flex items-center">
                        <!-- Á©∫ÁôΩÂ∞±ÊòØblank Êñá‰ª∂Â§πÂ∞±ÊòØfolder -->
                        <div class="relative flex-shrink-0">
                          <XFileTypeIcon
                            class="w-6 h-6 cursor-pointer"
                            :type="record.userFile.fileType"
                            @click="onItemIconClick(record)"
                          />
                          <div
                            v-if="isCanFilePreview(record)"
                            class="absolute text-white bottom-0 font-12 bg-gray-400 opacity-70 left-0 right-0 text-center"
                            :style="{
                              height: '14px',
                              'line-height': '14px',
                            }"
                          >
                            <div
                              class="cursor-pointer"
                              :style="{
                                transform: 'scale(.833)',
                              }"
                              @click="onItemIconClick(record)"
                            >È¢ÑËßà</div>
                          </div>
                        </div>

                        <a
                          href="javascript:;"
                          class="mx-2"
                          :title="lastOfArray(record.userFile.fullName)"
                          @click="onItemNameClick(record)"
                        >{{ lastOfArray(record.userFile.fullName) }}</a>
                        <!-- class="truncate" -->
                        <div
                          class="text-overflow-2"
                          v-if="
                            cacheFormatDescription(
                              record.userFile.info.description
                            ).tagArr.length
                          "
                        >
                          <template
                            v-for="(tag, idx) in cacheFormatDescription(
                              record.userFile.info.description
                            ).tagArr"
                          >
                            <a-tag
                              v-if="tag"
                              :key="tag"
                              :color="TAG_COLOR_LIST[idx]"
                              class="mr-1"
                            >{{ tag }}</a-tag>
                          </template>
                        </div>
                        <!-- hover ÊâçÊòæÁ§∫ÁöÑshortCutÊ†è -->
                        <!-- Èùû‰∏äÁ∫ßÁõÆÂΩï -->
                        <div class="tableShortcut hidden inline-block absolute right-0">
                          <!-- ‰øùÂ≠òÂà∞ÁΩëÁõò -->
                          <a-tooltip title="‰øùÂ≠òÂà∞ÁΩëÁõò">
                            <a
                              class="shortcutButton ml-1"
                              href="javascript:;"
                              @click="
                                saveToMetanetModalPreAction([record.userFile])
                              "
                            >
                              <ExportOutlined />
                            </a>
                          </a-tooltip>
                          <!-- ‰∏ãËΩΩ -->
                          <a-tooltip title="‰∏ãËΩΩ">
                            <a
                              class="shortcutButton ml-1"
                              href="javascript:;"
                              @click="onRecordDownload(record)"
                            >
                              <DownloadOutlined />
                            </a>
                          </a-tooltip>
                          <!-- ËØÑ‰ª∑ -->
                          <!-- <a-tooltip title="ËØÑ‰ª∑">
                        <a
                          class="shortcutButton ml-1"
                          href="javascript:;"
                          @click="onRecordScore(record)"
                          ><HighlightOutlined
                        /></a>
                          </a-tooltip>-->
                        </div>
                      </div>
                    </template>
                    <template #hash="{ record }">
                      <XTdHash
                        v-if="record.userFile && record.userFile.hash"
                        :hash="record.userFile.hash"
                      />
                    </template>
                    <template #feedBack>
                      <div class="flex">
                        <div class="flex items-center mr-2">
                          <!-- v-if="isCurrentShareCollected" -->
                          <!-- :style="{ color: '#E54148' }" -->
                          <HeartFilled class="mr-1 text-gray-500" />
                          <!-- <HeartOutlined v-else class="mr-1" /> -->
                          <!-- {{ record.collectedCount }} -->
                          66
                        </div>
                        <div class="flex items-center">
                          <CommentOutlined class="mr-1" />
                          <!-- <HeartFilled /> -->
                          <!-- {{ record.commentCount || "--" }} -->
                          66
                        </div>
                      </div>
                    </template>
                  </XTableFiles>
                  <!-- ÂºπÁ™ó ‰øùÂ≠òÂà∞ÁΩëÁõò -->
                  <XModalDir
                    rowKey="dirId"
                    title="‰øùÂ≠òÂà∞ÁΩëÁõò"
                    v-model:visible="isShowSaveToMetanetModal"
                    @ok="onSaveToMetanetModalConfirm"
                    :rowClassName="saveToMetanetModalTableRowClassName"
                    :columns="saveToMetanetTableColumns"
                    :dataSource="saveToMetanetModalTableData"
                    :customRow="saveToMetanetModalTableCustomRow"
                    :tableLoading="saveToMetanetModalTableLoading"
                    :confirmLoading="saveToMetanetModalConfirmLoading"
                  />
                </div>
              </template>
            </template>
            <!-- Êñá‰ª∂Êó†Êïà -->
            <template v-else>
              <!-- color: #faad14; -->
              <div class="pt-40 flex flex-col items-center justify-center">
                <WarningFilled
                  class="mb-4"
                  :style="{
                    'font-size': '80px',
                    color: '#faad14',
                  }"
                />
                <div class="font-semibold font-20">Êñá‰ª∂Â∑≤Âà†Èô§ÊàñÂ∑≤ËøáÊúü</div>
              </div>
              <!-- <a-result class="pt-30" status="warning" title="Êñá‰ª∂Â∑≤ËøáÊúüÊàñË¢´Âà†Èô§"> -->
              <!-- <template #extra>
              <a-button key="console" type="primary">Go Console</a-button>
              </template>-->
              <!-- </a-result> -->
            </template>
          </template>
        </div>
      </a-spin>
    </main>
    <a-modal
      :destroyOnClose="true"
      v-model:visible="isShowDescriptionModal"
      :title="`ÊèèËø∞‰ø°ÊÅØ-${currentDescriptionModalFileName}`"
      :footer="null"
    >
      <XMdParser v-if="currentDescription" :content="currentDescription" />
      <div v-else class="text-gray-400 text-center">ÊöÇÊó†ÊèèËø∞</div>
    </a-modal>
  </div>
</template>

<script setup lang="ts">
import {
  computed,
  defineComponent,
  h,
  onActivated,
  onDeactivated,
  onMounted,
  reactive,
  ref,
  watch,
} from "vue";
import {
  apiCollectCreateByShare,
  apiDriveSaveShareFile,
  apiGetPreviewToken,
  apiPriviewSharedFile,
  apiQueryCollectList,
  apiQueryDirSize,
  apiLoopQueryFileByDir,
  apiQuerySharedFile,
  apiSecondUpload,
  QueryShareFileItem,
} from "../../../apollo/api";
import type { TFileItem } from '../../../apollo/api'
import dayjs from "dayjs/esm";
import {
  onBeforeRouteLeave,
  onBeforeRouteUpdate,
  useRoute,
  useRouter,
} from "vue-router";
import { message } from "ant-design-vue";
import {
  XFileTypeIcon,
  XTableFiles,
  XSvgIcon,
  XTdHash,
  XModalDir,
  XUserAvatar,
  XMdParser,
  XLocaleSwither,
} from "../../../components/desktop";
import { useI18n } from "vue-i18n";
import {
  downloadFileByUrl,
  formatBytes,
  getFileType,
  lastOfArray,
  cacheFormatDescription,
  makeShareUrlByUri,
  cacheFn,
  useDelay,
  transformRawDescription,
  makeFileUrl,
} from "../../../hooks";
import {
  ExportOutlined,
  DownloadOutlined,
  HeartFilled,
  HeartOutlined,
  HighlightOutlined,
  LoadingOutlined,
  WarningFilled,
  CommentOutlined,
  StarOutlined,
  StarFilled,
  InfoCircleOutlined,
  EditOutlined,
} from "@ant-design/icons-vue";
import { TDir } from "./components/FileItem.vue";
import { useBaseStore, useUserStore } from "../../../store";
import { FILE_TYPE_MAP, TAG_COLOR_LIST } from "../../../constants";
import ModalDetail, { TDetailInfo } from "./components/ModalDetail.vue";
import { onClickOutside } from "@vueuse/core";

type ListItem = {
  userFile: QueryShareFileItem["userFile"];
  checked: boolean;
  id: string; // ÂàÜ‰∫´ÁöÑid(Ê≤°ÊúâÂ∞±Áî®Á©∫)
  token: string;
};

function sortByDirType(a: ListItem, b: ListItem) {
  return a.userFile?.isDir ? (b.userFile?.fullName[0] === "..." ? 1 : -1) : 1;
}

const idMapDescriptionCache = new Map<
  string,
  { fileName: string; descSource: string }
>();

// Ê†πÊçÆuri
const { t } = useI18n();
const router = useRouter();
const route = useRoute();
const baseStore = useBaseStore();
const userStore = useUserStore();
const currentUri = ref("");
const currentShareToken = ref("");
const currentShareId = ref("");
/** ÂàõÂª∫Êó∂Èó¥ */
const insertedAtText = ref("");
/** ÊèèËø∞ÂºπÁ™óÁöÑÊ†áÈ¢ò */
const currentDescriptionModalFileName = ref("");
/** ÊòæÁ§∫ÁöÑÊèèËø∞‰ø°ÊÅØ */
const currentDescription = ref("");
/** Âú∞ÂùÄÊ†èÊòØÂê¶ÊòæÁ§∫ÊèèËø∞Êñá‰ª∂ÁöÑÂêçÁß∞ */
const isShowDescriptionModalFileNameInAddressBar = ref(false);
/** ËÆæÁΩÆËØ¶ÊÉÖÂºπÁ™óÁöÑÊ†áÈ¢òÂíåÂÜÖÂÆπ */
const setCurrentDescriptionModalData = (
  id: string,
  fileName: string,
  descSource: string
) => {
  currentDescriptionModalFileName.value = fileName;
  currentDescription.value = descSource;
  if (!idMapDescriptionCache.has(id)) {
    idMapDescriptionCache.set(id, {
      fileName,
      descSource,
    });
  }
};
const setCurrentDescriptionModalDataFromCache = (id: string) => {
  const e = idMapDescriptionCache.get(id);
  if (!e) {
    throw Error(`Ê≤°ÊúâÊâæÂà∞ÊîπÊñá‰ª∂id ${id}ÁöÑÁºìÂ≠ò`);
  }
  const { fileName, descSource } = e;
  currentDescriptionModalFileName.value = fileName;
  currentDescription.value = descSource;
};
/** Â¶ÇÊûúÂàÜ‰∫´ÊòØÊñá‰ª∂Â§π, Ëøô‰∏™Êñá‰ª∂Â§πÁöÑdirId */
let firstFolderDirId = "0";
const fileTableRef = ref(null);
/** ÁÇπÂáªÈô§‰∫ÜË°®Ê†ºÁöÑÂÖ∂‰ªñÂú∞Êñπ, ÈáçÁΩÆÂΩìÂâçÁÇπÂáªÈ°π(ËøòÂéüÂú∞ÂùÄÊ†è),Èô§‰∫ÜÂú∞ÂùÄÊ†èÁöÑÊî∂Ëóèicon
 *  Êñá‰ª∂Â§πÁöÑÊÉÖÂÜµ‰∏ãÊâçÂºÄÂêØ, ÂçïÊñá‰ª∂‰∏çÁî®ÂèòÊõ¥Âú∞ÂùÄÊ†èÂíåËØ¶ÊÉÖ
 */
const useClickOutSideWhenShareIsFolder = () => {
  // onClickOutside(fileTableRef, (e) => {
  //   if (!isShowDescriptionModal.value) {
  //     setTimeout(() => {
  //       // console.log("e", e.target);
  //       // Â∑≤ÁªèÊâìÂºÄÂºπÁ™óÁöÑÊÉÖÂÜµ‰∏ã, ‰∏çÈáçÁΩÆÊèèËø∞ÂºπÁ™óÂÜÖÂÆπ
  //       if (isShowDescriptionModal.value) {
  //         return;
  //       }
  //       isShowDescriptionModalFileNameInAddressBar.value = false;
  //       // ËÆæÁΩÆÂõûÂΩìÂâçÊñá‰ª∂Â§πÁöÑËØ¶ÊÉÖ
  //       const len = historyDir.value.length;
  //       if (len === 1) {
  //         // ÂÖ®ÈÉ®Êñá‰ª∂
  //         setCurrentDescriptionModalDataFromCache(firstFolderDirId);
  //       } else {
  //         // ‰∫å/3Á∫ßÊñá‰ª∂Â§π
  //         setCurrentDescriptionModalDataFromCache(
  //           historyDir.value.length
  //             ? lastOfArray(historyDir.value).dirId
  //             : firstFolderDirId
  //         );
  //       }
  //     }, 100);
  //   }
  // });
};

/** ÂΩìÂâçËøô‰∏™ÂàÜ‰∫´ÁöÑÊî∂ËóèÊï∞ */
const curShareCollectedCount = ref(0);
/** ÊòØÂê¶Ê≠£Âú®Âä†ËΩΩÂàóË°®‰∏≠ÁöÑÊï∞ÊçÆ */
const isLoadingListData = ref(false);
/** ÂΩìÂâçÁöÑÂàÜ‰∫´ÊòØÂê¶Êî∂ËóèËøá */
const isCurrentShareCollected = ref(false);
/** ÂΩìÂâçÁöÑÂàÜ‰∫´ÊòØÂê¶ÊòØÂçï‰∏™Êñá‰ª∂Â§π */
const isCurrentShareFolder = ref(false);
const userPreview = reactive({
  avatar: "",
  bio: "",
  email: "",
  username: "",
});
/** Áî®Êà∑ÊòØÂê¶ÁôªÂΩïÁä∂ÊÄÅ */
const isUserLoggedIn = computed(() => {
  return userStore.isLoggedIn;
});
/** Ê£ÄÊü•ÁôªÂΩïËΩ¨ÊÄÅÂπ∂ËøîÂõûÊòØÂê¶ÁôªÂΩï,Êú™ÁôªÂΩïÂ∞±ÊâìÂºÄÁôªÂΩïÂºπÁ™ó */
const checkLoginStatusThenOpenModalSignIn = (): boolean => {
  if (!isUserLoggedIn.value) {
    baseStore.changeIsShowLoginModal(true);
    // router.push({
    //   name: "Login",
    //   query: {
    //     redirect: route.fullPath,
    //   },
    // });
    return true;
  }
  return false;
};
/** ÁÇπÂáªlogo */
const onClickLogo = () => {
  // 1. Áî®Êà∑Êú™ÁôªÂΩïÂ∞±ÂØºËà™Âà∞ÁôªÂΩïÈ°µ
  if (!isUserLoggedIn.value) {
    router.push({
      name: "Login",
    });
  } else {
    // 2. Áî®Êà∑ÁôªÂΩï‰∫ÜÂ∞±ÂØºËà™Âà∞Êñá‰ª∂tabÈ°µ
    const windowId = baseStore.getNewOpenWindowId();
    // console.log(`Â∑¶ËèúÂçïÊ†èÁÇπÂáªÁöÑ,Ëé∑ÂèñÁöÑËøòÊú™ÊøÄÊ¥ªÁöÑwindoId,${windowId}`);
    router.push({
      name: "MetanetFile",
      query: {
        id: windowId,
        path: "~",
      },
    });
  }
};
/** ÁÇπÂáªÊú™ÁôªÂΩïÁä∂ÊÄÅ‰∏ãÁöÑusericon */
const onClickUnLoggInUserIcon = () => {
  checkLoginStatusThenOpenModalSignIn();
  // router.push({
  //   name: "Login",
  //   query: {
  //     redirect: route.fullPath,
  //   },
  // });
};
const selectedRowKeys = ref<string[]>([]);
const selectedRows = ref<ListItem[]>([]);
/** Ê∏ÖÈô§ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊï∞ÊçÆ */
const clearSelected = () => {
  selectedRows.value.length = 0;
  selectedRowKeys.value.length = 0;
};
const fileData = ref<ListItem[]>([]);
/**  ÈÄöËøáËÆøÈóÆÁ†ÅÊéßÂà∂‰∫ÜÊ≤° */
const isCodeResolved = ref(false);
/** Áî®Êà∑ËæìÂÖ•ÁöÑËÆøÈóÆÁ†Å */
const inputCode = ref("");
/** ÊòØÂê¶ÊúâÊïà(Áî®Êà∑Êú™Âà†Èô§Êñá‰ª∂,ÊúâÊïàÊúüÂÜÖ) */
const isValid = ref(true);
/** *ÂêéËøáÊúü*/
const expiredText = ref("");
const confirmLoading = ref(false);
/** ÈîÅ‰ΩèÈ°µÈù¢ÁöÑÊòæÁ§∫,Âõ†‰∏∫‰ªéÈ°µÈù¢ÊâìÂºÄÂà∞ËØ∑Ê±Çpreview ‰∏≠ÈúÄË¶ÅÊó∂Èó¥Âà§Êñ≠ÊòØÂê¶resolve‰∫ÜËÆøÈóÆÁ†Å */
const lockPageLoading = ref(true);
/** ÁõÆÂΩïÈù¢ÂåÖÂ±ë
 * ÂΩìÁÇπÂáªÁ¨¨‰∏Ä‰∏™ÁöÑÊó∂ÂÄôÊòØÁî®share ÁöÑapi,ÊâÄ‰ª•ËøôÈáåÁ¨¨‰∏Ä‰∏™dirId‰∏ç‰ºöË¢´Áî®Âà∞ */
const historyDir = ref<{ dirId: string; dirName: string }[]>([
  // { dirId: "none", dirName: "/" },
]);
/** ÁÇπÂáª‰∏ä‰∏ÄÁ∫ß */
const onUpperLevel = (dirIdx: number) => {
  // 1. Â¶ÇÊûúÁÇπÁöÑÊòØÂΩìÂâçÊñá‰ª∂Â§π
  if (dirIdx === historyDir.value.length - 1) {
    // 1.1 Â¶ÇÊûúÊúâ ÊèèËø∞Êñá‰ª∂Ê†è
    if (isShowDescriptionModalFileNameInAddressBar.value) {
      isShowDescriptionModalFileNameInAddressBar.value = false;
      const _dirId = historyDir.value[dirIdx].dirId;
      setCurrentDescriptionModalDataFromCache(_dirId);
    } else if (dirIdx === 0) {
      // 1.2 Â¶ÇÊûúÊ≤°Êúâ ÊèèËø∞Êñá‰ª∂Ê†è ‰∏îÊòØÊ†πÁõÆÂΩï, Êî∂Ëµ∑ÊâÄÊúâÂú∞ÂùÄÊ†è
      historyDir.value.length = 0;
      getSetFileData();
      setCurrentDescriptionModalDataFromCache(firstFolderDirId);
    }
  } else {
    // 2. Â¶ÇÊûúÁÇπÁöÑ‰∏çÊòØÂΩìÂâçÊñá‰ª∂Â§π
    // 2.1 Â¶ÇÊûúÊúâ ÊèèËø∞Êñá‰ª∂Ê†è
    if (isShowDescriptionModalFileNameInAddressBar.value) {
      isShowDescriptionModalFileNameInAddressBar.value = false;
      const _dirId = historyDir.value[dirIdx].dirId;
      setCurrentDescriptionModalDataFromCache(_dirId);
    }
    historyDir.value.splice(dirIdx + 1);
    const dirId = lastOfArray(historyDir.value).dirId;
    getSetDriveList(dirId);
    setCurrentDescriptionModalDataFromCache(dirId);
  }
};
/** ÁÇπÂáªÊñá‰ª∂ÂõæÊ†á */
const onItemIconClick = async (record: ListItem) => {
  // console.log("onItemIconClick", record);
  if (!record.userFile) return;
  const fileType = getFileType({
    isDir: record.userFile.isDir,
    fileName: lastOfArray(record.userFile.fullName),
  });
  if (/folder$/g.test(fileType)) {
    // 1.ÊòØÊñá‰ª∂Â§π
    // 1.1 change historyDir
    historyDir.value.push({
      dirId: record.userFile.id,
      dirName: lastOfArray(record.userFile.fullName),
    });
    getSetDriveList(record.userFile.id);
    setCurrentDescriptionModalData(
      record.userFile.id,
      lastOfArray(record.userFile.fullName),
      record.userFile.info.description || ""
    );
    isShowDescriptionModalFileNameInAddressBar.value = false;
    // 1.2 change fileData
  } else if (FILE_TYPE_MAP.image.includes(fileType)) {
    const { user, space, id: fileId, fullName } = record.userFile;
    // ÂàÜ‰∫´ÁöÑÈ¢ÑËßàÁî®ÁöÑtoken ÊòØËØ•ÂàÜ‰∫´Êï∞ÊçÆÁöÑtoken
    const token = record.token;
    const tableImgList = fileData.value.filter(
      (item) =>
        item.userFile !== null &&
        FILE_TYPE_MAP.image.includes(item.userFile.fileType ?? "")
    );
    const toPreviewList = tableImgList.map((item) => ({
      src: makeFileUrl({
        urlType: "preview",
        token: token,
        userId: item.userFile?.user.id ?? "",
        space: item.userFile?.space ?? "",
        fileId: item.userFile?.id ?? "",
        fileName: item.userFile?.fullName.slice(-1)[0] ?? "",
        updateAt: item.userFile?.updatedAt ?? "",
      }),
      w: 0,
      h: 0,
      title: item.userFile?.info.description
        ? transformRawDescription(item.userFile?.info.description)
        : "",
    }));
    // ÊâæÂá∫ÂΩìÂâçÁÇπÂáªÁöÑÂõæÁâáÁöÑ openIndex
    const startImgIdx = tableImgList.findIndex((i) => i.id === record.id);
    // const url = `https://drive-s.owaf.io/preview/${
    //   user.id
    // }/${space.toLowerCase()}/${fileId}/${
    //   fullName.slice(-1)[0]
    // }?token=${token}&t=${dayjs(record.userFile.updatedAt).format(
    //   "YYYYMMDDHHmmss"
    // )}`;
    baseStore.setPhotoSwipeAndShow(toPreviewList, { index: startImgIdx });
  } else if (fileType === "pdf") {
    // console.log("pdf");
    const token = record.token;
    const { user, space, id: fileId, fullName } = record.userFile;
    // const pdfUrl = `https://drive-s.owaf.io/preview/${
    //   user.id
    // }/${space.toLowerCase()}/${fileId}/${
    //   fullName.slice(-1)[0]
    // }?token=${token}&t=${dayjs(record.userFile.updatedAt).format(
    //   "YYYYMMDDHHmmss"
    // )}`;
    const pdfUrl = makeFileUrl({
      urlType: "preview",
      token,
      userId: user.id,
      space: space.toLowerCase(),
      fileId,
      fileName: fullName.slice(-1)[0],
      updateAt: record.userFile.updatedAt,
    });
    window.open(pdfUrl, "_blank");
  } else {
    // console.log("other-type");
    message.info("‰∏çÊîØÊåÅÈ¢ÑËßàËØ•Êñá‰ª∂");
  }
};
/** Êñá‰ª∂ÊòØÂê¶ÂèØÈ¢ÑËßà */
const isCanFilePreview = (record: ListItem) => {
  // Êñá‰ª∂Êàñpdf
  const f = record.userFile;
  if (!f) return false;
  const e = getFileType({
    isDir: f.isDir,
    fileName: lastOfArray(f.fullName),
  });
  if (FILE_TYPE_MAP.image.includes(e) || e === "pdf") {
    return true;
  }
  // ÂÖ∂‰ªñÁ±ªÂûãËøîÂõûfalse
  return false;
};
/** ÁÇπÂáªÊñá‰ª∂Âêç, Âú∞ÂùÄÊ†èÊòæÁ§∫, ËÆæÁΩÆËØ¶ÊÉÖÊï∞ÊçÆ */
const onItemNameClick = async (record: ListItem) => {
  // console.log("onItemNameClick");
  const e = record.userFile;
  if (!e) {
    return;
  }
  // Â¶ÇÊûúÊòØÊñá‰ª∂Â§π, Â∞±ËøõÂÖ•Êñá‰ª∂Â§π, Êõ¥Êñ∞Âú∞ÂùÄÊ†èÂíåËØ¶ÊÉÖÊï∞ÊçÆ
  if (e.isDir) {
    historyDir.value.push({
      dirId: e.id,
      dirName: lastOfArray(e.fullName),
    });
    getSetDriveList(e.id);
    setCurrentDescriptionModalData(
      e.id,
      lastOfArray(e.fullName),
      e.info.description || ""
    );
    isShowDescriptionModalFileNameInAddressBar.value = false;
  } else {
    // Â¶ÇÊûúÊòØÊñá‰ª∂, Êõ¥Êñ∞Âà∞Âú∞ÂùÄÊ†è, Âπ∂ËÆæÁΩÆËØ¶ÊÉÖ
    setCurrentDescriptionModalData(
      e.id,
      lastOfArray(e.fullName),
      e.info.description || ""
    );
    isShowDescriptionModalFileNameInAddressBar.value = true;
  }
};
/** ËØ∑Ê±ÇÁõÆÂΩïÈáåÈù¢ÁöÑÊï∞ÊçÆ */
const getSetDriveList = (dirId: string) => {
  const token = currentShareToken.value;
  isLoadingListData.value = true;
  apiLoopQueryFileByDir({
    dirId,
    token,
    startPage: 1,
  }).then((res) => {
    isLoadingListData.value = false;
    if (res.err || !res.data) {
      return;
    }
    fileData.value.length = 0;
    res.data.driveListFiles.forEach((item) => {
      if (!item || item.id === dirId || item.fullName.length === 0) return;
      fileData.value.push({
        id: item.id,
        checked: false,
        token: currentShareToken.value,
        userFile: {
          ...item,
          fileType: getFileType({
            isDir: item.isDir,
            fileName: lastOfArray(item.fullName),
          }),
        },
      });
    });
    fileData.value.sort(sortByDirType);
  });
};
/** ËæìÂÖ•ËÆøÈóÆÁ†ÅÂêéÁöÑÁ°ÆËÆ§ */
const onConfirmCode = () => {
  // console.log("onConfirmCode");
  if (!inputCode.value.length) {
    // TODO Ë∑üÂàÜ‰∫´ÁöÑÊó∂ÂÄô‰∏ÄËµ∑ Âä†ÂÖ•ÂØπÂàÜ‰∫´Á†ÅÁöÑËæìÂÖ•Ê†°È™å
    message.warning("ËØ∑ËæìÂÖ•ËÆøÈóÆÁ†Å");
    return;
  }
  confirmLoading.value = true;
  getSetFileData().finally(() => {
    confirmLoading.value = false;
  });
};
const columns = [
  {
    title: t("metanet.name"),
    slots: { customRender: "name" },
    sortDirections: ["descend", "ascend"],
    sorter: (a: QueryShareFileItem, b: QueryShareFileItem) => {
      // Êñá‰ª∂Â§πÁöÑÊéíÂú®ÂâçÈù¢
      if (a.userFile?.isDir && !b.userFile?.isDir) return 0;
      else if (!a.userFile?.isDir && b.userFile?.isDir) return 0;
      return lastOfArray(a.userFile?.fullName ?? []).localeCompare(
        lastOfArray(b.userFile?.fullName ?? [])
      );
    },
  },
  {
    title: t("metanet.size"),
    dataIndex: "userFile.info.size",
    width: 100,
    customRender: ({
      record,
      text,
    }: {
      record: QueryShareFileItem;
      text: string;
    }) => {
      return record.userFile?.isDir ? "" : formatBytes(+text);
    },
    sortDirections: ["descend", "ascend"],
    sorter: (a: QueryShareFileItem, b: QueryShareFileItem) => {
      // Êñá‰ª∂Â§πÁöÑÊéíÂú®ÂâçÈù¢
      if (a.userFile?.isDir && !b.userFile?.isDir) return 0;
      else if (!a.userFile?.isDir && b.userFile?.isDir) return 0;
      const aSize = a.userFile?.info.size ?? 0;
      const bSize = b.userFile?.info.size ?? 0;
      return +aSize - +bSize;
    },
  },
  {
    title: "Hash",
    dataIndex: "hash",
    slots: { customRender: "hash" },
    width: 150,
  },
  {
    title: t("metanet.updatedAt"),
    dataIndex: "updatedAt",
    customRender: ({ record }: { record: QueryShareFileItem }) => {
      return record.userFile
        ? dayjs(record.userFile?.updatedAt).format("YYYY-MM-DD hh:mm")
        : "";
    },
    width: 180,
    sortDirections: ["descend", "ascend"],
    sorter: (a: QueryShareFileItem, b: QueryShareFileItem) => {
      // Êñá‰ª∂Â§πÁöÑÊéíÂú®ÂâçÈù¢
      if (a.userFile?.isDir && !b.userFile?.isDir) return 0;
      else if (!a.userFile?.isDir && b.userFile?.isDir) return 0;
      return dayjs(a.userFile?.updatedAt).diff(
        dayjs(b.userFile?.updatedAt)
      );
    },
  },
  {
    title: "ÂõûÈ¶à",
    dataIndex: "feedBack",
    slots: { customRender: "feedBack" },
    width: 100,
  },
];
/** ÊòæÁ§∫ËØ•ÂàÜ‰∫´ */
const onShowDescriptionModal = () => {
  isShowDescriptionModal.value = true;
};
/** ËØÑËÆ∫ËØ•ÂàÜ‰∫´ */
const onCommentShare = () => {
  message.info("TODO");
};

/** ÊòØÂê¶ÊòæÁ§∫ÊèèËø∞ÂºπÁ™ó */
const isShowDescriptionModal = ref(false);
// watch(
//   () => isShowDescriptionModal.value,
//   (newVal) => {
//     if (newVal === false) {
//       currentDescription.value = "";
//     }
//   }
// );
// TODO Êñá‰ª∂Â§π ÊîØÊåÅ‰∏ä‰∏ÄÁ∫ßÁõÆÂΩï
/** shortcut-‰∏ãËΩΩ */
const onRecordDownload = (record: ListItem) => {
  // if (checkLoginStatusThenOpenModalSignIn()) {
  //   return;
  // }
  // console.log("onRecordDownload", record);
  // TODO Âà§Êñ≠ÊúâÊ≤°ÁôªÂΩï
  if (!record.userFile) return;
  const { user, space, id: fileId, fullName } = record.userFile;
  const downloadToken = record.token;
  // apiGetPreviewToken().then((resultPreviewToken) => {
  if (!record.userFile) return;
  // if (resultPreviewToken.err) return;
  // const token = resultPreviewToken.data.drivePreviewToken;
  // const url = `https://drive-s.owaf.io/download/${
  //   user.id
  // }/${space.toLowerCase()}/${fileId}/${
  //   fullName.slice(-1)[0]
  // }?token=${downloadToken}&t=${dayjs(record.userFile.updatedAt).format(
  //   "YYYYMMDDHHmmss"
  // )}`;
  const hideLoadingMsg = message.loading("ËØ∑Ê±ÇÊï∞ÊçÆ‰∏≠...", 0);
  const url = makeFileUrl({
    urlType: "download",
    token: downloadToken,
    userId: user.id,
    space: space.toLowerCase(),
    fileId,
    fileName: fullName.slice(-1)[0],
    updateAt: record.userFile.updatedAt,
  });
  downloadFileByUrl({
    url,
    fileName: fullName.slice(-1)[0],
    onAfterFetch: () => hideLoadingMsg(),
  });
  // });
};
/** shortcut -ËØÑ‰ª∑ */
const onRecordScore = (record: ListItem) => {
  if (checkLoginStatusThenOpenModalSignIn()) {
    return;
  }
  // console.log("onRecordScore", record);
};
/** ÊâπÈáè‰∏ãËΩΩ */
const onBatchDownload = () => {
  // if (checkLoginStatusThenOpenModalSignIn()) {
  //   return;
  // }
  selectedRows.value.forEach((i) => {
    if (i.userFile && !i.userFile.isDir) {
      onRecordDownload(i);
    }
  });
};
/** ÂéãÁº©‰∏ãËΩΩ */
const onZipDownload = () => {
  message.info("TODO");
};
/** ÊâπÈáèÊî∂Ëóè */
const onCollectShare = async () => {
  if (checkLoginStatusThenOpenModalSignIn()) {
    return;
  }
  if (isCurrentShareCollected.value) {
    message.info("‰Ω†Â∑≤Êî∂ËóèËøáÊîπÂàÜ‰∫´");
    // const res = await apiCollectDelete({ id: currentShareId.value });
    // if (res.err || !res.data) {
    //   return;
    // }
    // isCurrentShareCollected.value = false;
    // Toast("ÂèñÊ∂àÊî∂ËóèÊàêÂäü");
  } else {
    const res = await apiCollectCreateByShare({ id: currentShareId.value });
    if (res.err || !res.data) {
      return;
    }
    isCurrentShareCollected.value = true;
    curShareCollectedCount.value += 1;
    message.success("Êî∂ËóèÊàêÂäü");
  }
};
/** ÂàÜ‰∫´Âà∞ÂÖ∂‰ªñÂπ≥Âè∞ */
const onPlatformShare = () => {
  message.info("TODO");
};
/** ÊâπÈáèËØÑ‰ª∑ */
const onBatchScore = () => {
  if (checkLoginStatusThenOpenModalSignIn()) {
    return;
  }
  console.log("onBatchScore");
};
/** Ëé∑ÂèñÊñá‰ª∂‰ø°ÊÅØ */
const getSetFileData = async () => {
  isLoadingListData.value = true;
  const { data, err } = await apiQuerySharedFile({
    uri: currentUri.value,
    ...(!isCodeResolved.value
      ? {
        code: inputCode.value,
      }
      : {}),
  });
  isLoadingListData.value = false;
  if (err || !data) return;
  if (data.driveFindShare === null) {
    message.warning("ËÆøÈóÆÁ†ÅÈîôËØØ");
    return;
  }
  if (data.driveFindShare.userFile === null) {
    // Áî®Êà∑ Âà†Èô§ÂéüÊñá‰ª∂
    console.log("userFile‰∏∫null,Êù•Ê∫êÁî®Êà∑Âà†Èô§‰∫ÜËØ•Êñá‰ª∂");
    isValid.value = false;
    return;
  }
  // Ê≥®ÂÜåÂΩìÂâçÂàÜ‰∫´ÁöÑtoken
  currentShareToken.value = data.driveFindShare.token;
  currentShareId.value = data.driveFindShare.id;
  isCurrentShareFolder.value = data.driveFindShare.userFile.isDir;
  if (isCurrentShareFolder.value) {
    firstFolderDirId = data.driveFindShare.userFile.id;
    useClickOutSideWhenShareIsFolder();
  }
  // Áõ¥Êé•Ê≥®ÂÜåËØ¶ÊÉÖ
  setCurrentDescriptionModalData(
    data.driveFindShare.userFile.id,
    lastOfArray(data.driveFindShare.userFile.fullName),
    data.driveFindShare.userFile.info.description || ""
  );
  // Êü•ËØ¢ÂΩìÂâçÂàÜ‰∫´ÊòØÂê¶Êî∂ËóèËøá
  // isCurrentShareCollected
  apiQueryCollectList({ type: "SHARE" }).then((res) => {
    if (res.data) {
      isCurrentShareCollected.value = res.data.driveListCollections.some(
        (i) => i.item?.id === data.driveFindShare.id
      );
    }
  });
  curShareCollectedCount.value = data.driveFindShare.collectedCount;
  // ÊääÁî®Êà∑ËæìÂÖ•ËøáÁöÑÂ≠òÂà∞sessionStorage Èáå
  sessionStorage.setItem(currentUri.value, inputCode.value);
  fileData.value.length = 0;
  fileData.value.push({
    // ÊîπÂèòfullname ÂíåfileType
    ...data.driveFindShare,
    userFile: {
      ...data.driveFindShare.userFile,
      fullName: data.driveFindShare.userFile.fullName,
      fileType: getFileType({
        isDir: data.driveFindShare.userFile.isDir,
        fileName: lastOfArray(data.driveFindShare.userFile.fullName),
      }),
    },
    checked: false,
  });
  isValid.value = true;
  isCodeResolved.value = true;
};
// http://localhost:4000/#/metanet/sharedFile?uri=vQfgupqRey2465R5NCqtDg
// vQfgupqRey2465R5NCqtDg
// TODO Êñá‰ª∂Â∑≤ÁªèÂ§±Êïà userFile null
const handleUriChange = (queryUri: string) => {
  if (currentUri.value !== queryUri) {
    fileData.value.length = 0;
    currentUri.value = queryUri;
    apiPriviewSharedFile({ uri: queryUri }).then(({ data, err }) => {
      if (err || !data || !data.drivePreviewShare) {
        isValid.value = false;
        lockPageLoading.value = false;
        return;
      }
      const { userPreview: resUserPreview } = data.drivePreviewShare;
      // Ê≥®ÂÜå ÂàÜ‰∫´Êù•Ê∫êÁî®Êà∑ÁöÑ‰ø°ÊÅØ
      userPreview.avatar = resUserPreview.avatar || "";
      userPreview.bio = resUserPreview.bio;
      userPreview.email = resUserPreview.email;
      userPreview.username = resUserPreview.username;
      // Â¶ÇÊûúÊñá‰ª∂ÈúÄË¶ÅËÆøÈóÆÁ†Å, Âàô ËÆøÈóÆÁ†ÅÊéßÂà∂false,Á≠âÂæÖÂêéÈù¢ËæìÂÖ•
      isCodeResolved.value = !data.drivePreviewShare.needCode;
      const diffNow = dayjs(data.drivePreviewShare.expiredAt).diff(dayjs());
      // Â¶ÇÊûúÊñá‰ª∂ËøáÊúü‰∫Ü
      if (diffNow < 0) {
        isValid.value = false;
        lockPageLoading.value = false;
        return;
      }
      expiredText.value = `${dayjs(data.drivePreviewShare.expiredAt).diff(
        dayjs(),
        "days"
      )}Â§©ÂêéËøáÊúü`;
      insertedAtText.value = dayjs(
        data.drivePreviewShare.insertedAt
      ).format("YY-MM-DD");
      // Â¶ÇÊûú‰∏çÈúÄË¶ÅËÆøÈóÆÁ†Å, Á´ãÂç≥ËØ∑Ê±ÇÊñá‰ª∂
      if (isCodeResolved.value === true) {
        getSetFileData().finally(() => {
          lockPageLoading.value = false;
        });
      } else if (sessionStorage.getItem(queryUri)) {
        // Â¶ÇÊûúsessionStorage ÈáåÊúâuri , ÊãøÂá∫Êù•Áî®
        inputCode.value = sessionStorage.getItem(queryUri) as string;
        getSetFileData().finally(() => {
          lockPageLoading.value = false;
        });
      } else {
        lockPageLoading.value = false;
      }
    });
  }
};
// TODO Ëß£ÂÜ≥‰∏§‰∏™ÂàÜ‰∫´È°µÁöÑtab ÁÇπÂáªÂêéÊï∞ÊçÆÊ≤°ÂèòÁöÑÈóÆÈ¢ò
onMounted(() => {
  // console.log("onActivated-SharedFile-currentUri", currentUri);
  const queryUri = route.query.uri as string;
  if (queryUri) {
    handleUriChange(queryUri);
  }
});
/** ÂºπÁ™ó-‰øùÂ≠òÂà∞ÁΩëÁõò */
const isShowSaveToMetanetModal = ref(false);
const onSaveToMetanetModalConfirm = async () => {
  console.log("onSaveToMetanetModalConfirm");
  // Â¶ÇÊûúÊòØÊñá‰ª∂Â§π ‰∏çËÉΩ‰øùÂ≠òÂà∞Áõ∏ÂêåÊñá‰ª∂Â§πÂÜÖ
  const checkSameParent = (item: TFileItem) => {
    if (!item.isDir) return false;
    let dir: null | TDir = saveToMetanetModalSelectedDir.value;
    while (dir) {
      if (dir.dirId === item.id) return true;
      dir = dir.parent;
    }
    return false;
  };
  if (
    saveToMetanetModalSelectedFileList.value.some((i) =>
      checkSameParent(i)
    )
  ) {
    message.warning("ÁõÆÊ†áÊñá‰ª∂Â§πÂ∑≤ÂåÖÂê´Ë¶Å‰øùÂ≠òÁöÑÊñá‰ª∂!");
    return;
  }
  const targetDirId = saveToMetanetModalSelectedDir.value.dirId;
  let dir = saveToMetanetModalSelectedDir.value;
  const folderFullName = [dir.dirName];
  while (dir.parent) {
    dir = dir.parent;
    folderFullName.unshift(dir.dirName);
  }
  saveToMetanetModalConfirmLoading.value = true;
  // Ê†πÁõÆÂΩï‰∏çÁî®‰º†
  if (folderFullName[0] === "ÂÖ®ÈÉ®Êñá‰ª∂") folderFullName.shift();
  await Promise.allSettled(
    saveToMetanetModalSelectedFileList.value.map((i) =>
      // apiSecondUpload({
      //   // ÂåÖÂê´Ë¶Å‰øùÂ≠òÁöÑË∑ØÂæÑÁöÑÊñá‰ª∂ÂÖ®ÂêçÊï∞ÁªÑ
      //   fullName: [...folderFullName, lastOfArray(i.fullName)],
      //   description: i.info.description || "",
      //   fileHash: i.hash,
      // })
      apiDriveSaveShareFile({
        code: inputCode.value,
        fromUserFileId: i.id,
        id: currentShareId.value,
        toUserFileId: targetDirId,
      })
    )
  ).finally(() => {
    message.success("‰øùÂ≠òÊàêÂäü");
    saveToMetanetModalConfirmLoading.value = false;
    isShowSaveToMetanetModal.value = false;
  });
};
const saveToMetanetModalTableRowClassName = (record: TDir) => {
  return record.dirId === saveToMetanetModalSelectedDir.value.dirId
    ? "copyMoveModalRow copyMoveModalRowActive"
    : "copyMoveModalRow";
};
/** ËÆæÁΩÆËá™ÂÆö‰πâË°åonClick ‰∫ã‰ª∂ */
const saveToMetanetModalTableCustomRow = (record: TDir) => ({
  onClick: (e: {
    currentTarget: {
      dataset: {
        rowKey: string;
      };
    };
  }) => {
    console.log("ee", record);
    // console.log(e.currentTarget.dataset.rowKey);
    saveToMetanetModalSelectedDir.value = record;
  },
});
const saveToMetanetTableColumns = [
  {
    title: "Name",
    slots: { customRender: "name" },
    key: "name",
  },
];
const saveToMetanetModalTableLoading = ref(false);
const saveToMetanetModalConfirmLoading = ref(false);
const saveToMetanetModalTableData = reactive<TDir[]>([]);
const saveToMetanetModalSelectedDir = ref<TDir>({
  dirId: "root",
  dirName: "ÂÖ®ÈÉ®Êñá‰ª∂",
  isExpend: true,
  parent: null,
});
const saveToMetanetModalSelectedFileList = ref<TFileItem[]>([]);
const getAndSetSaveToMetanetModalTableData = () => {
  saveToMetanetModalTableLoading.value = true;
  // 2021-07-05 ÂÖàÈÄíÂΩíÂ§ÑÁêÜÊâÄÊúâÁöÑÁõÆÂΩï, ÂêéÁª≠Ë¶ÅÊåâÈúÄÂä†ËΩΩ
  apiLoopQueryFileByDir({
    fileType: "DIR",
    dirId: "root",
    startPage: 1,
  }).then(async (resultQueryFile) => {
    if (resultQueryFile.err) {
      // console.log("err", err);
      saveToMetanetModalTableLoading.value = false;
      return;
    }
    /** Ê†πÊçÆÁõÆÂΩïid, Áà∂ÁõÆÂΩïid ÂéªÈÄíÂΩíËé∑Âèñchildren */
    const getAndSetDirChildren = async (item: TDir) => {
      const parentId = item.parent?.dirId;
      // const [resItem, errItem] = await apiLoopQueryFileByDir({
      const resultQueryFileItem = await apiLoopQueryFileByDir({
        fileType: "DIR",
        dirId: item.dirId,
        startPage: 1,
      });
      // console.log("ÁõÆÂΩïres", item.dirId, item.dirName, resItem);
      if (resultQueryFileItem.err) return item;
      // ÊéíÈô§ ÈùûÁõÆÂΩïÊñá‰ª∂/ Ê†πÁõÆÂΩï/ Ëá™Ë∫´/ Áà∂ÁõÆÂΩï(‰∏ä‰∏ÄÁ∫ß)
      const afterFilterList =
        resultQueryFileItem.data.driveListFiles.filter(
          (i): i is TFileItem =>
            i !== null &&
            i.isDir &&
            !["root", item.dirId, parentId].includes(i.id)
        );
      // console.log("afterFilterList", afterFilterList);
      if (!afterFilterList.length) return item;
      item.children = await Promise.all(
        afterFilterList.map((i) =>
          getAndSetDirChildren({
            dirId: i.id,
            dirName: lastOfArray(i.fullName),
            parent: item,
            isExpend: false,
          })
        )
      );
      return item;
    };
    // res.data.driveListFiles ÊèêÂèñÊñá‰ª∂Â§πÁöÑÂá∫Êù•
    const resIsDirList = resultQueryFile.data.driveListFiles.filter(
      (i): i is TFileItem => i !== null && i.isDir && i.id !== "root"
    );
    const withChildrensDirList = await Promise.all(
      resIsDirList.map((i) =>
        getAndSetDirChildren({
          dirId: i.id,
          dirName: lastOfArray(i.fullName),
          isExpend: false,
          parent: {
            dirId: "root",
            dirName: "ÂÖ®ÈÉ®Êñá‰ª∂",
            isExpend: true,
            parent: null,
          },
        })
      )
    );
    const rootDir: TDir = {
      dirId: "root",
      dirName: "ÂÖ®ÈÉ®Êñá‰ª∂",
      isExpend: true,
      parent: null,
      children: withChildrensDirList,
    };
    saveToMetanetModalTableData.push(rootDir);
    saveToMetanetModalTableLoading.value = false;
  });
};
/** ËÆæÁΩÆË¶ÅÁßªÂä®ÁöÑidList,Êìç‰ΩúÁ±ªÂûã */
const saveToMetanetModalPreAction = (itemList: TFileItem[]) => {
  if (checkLoginStatusThenOpenModalSignIn()) {
    return;
  }
  // ÈáçÁΩÆ‰∏∫ÂÖ®ÈÉ®Êñá‰ª∂
  saveToMetanetModalSelectedDir.value = {
    dirId: "root",
    dirName: "ÂÖ®ÈÉ®Êñá‰ª∂",
    isExpend: true,
    parent: null,
  };
  // Â¶ÇÊûú‰øùÂ≠òÁöÑÁõÆÊ†áÊñá‰ª∂Â§π Áî®Êà∑Âèà‰øùÂ≠òÂà∞‰ªñËá™Â∑±ÁöÑÁõ∏ÂêåÁõÆÂΩï‰∏ã
  saveToMetanetModalSelectedFileList.value.length = 0;
  // saveToMetanetModalSelectedFileList.value.push(...itemList);
  saveToMetanetModalSelectedFileList.value =
    saveToMetanetModalSelectedFileList.value.concat(itemList);
  isShowSaveToMetanetModal.value = true;
  // ÊØèÊ¨°ÊâìÂºÄÂºπÁ™óÈÉΩËé∑ÂèñÊúÄÊñ∞ÁöÑÊñá‰ª∂Â§πÊï∞ÊçÆ
  saveToMetanetModalTableData.length = 0;
  getAndSetSaveToMetanetModalTableData();
};
// ÊâãÊú∫ÂØºËà™ÂêéÈÄÄÁöÑÊó∂ÂÄô,Ê£ÄÊü•ÊúâÊ≤°ÂÖàÂÖ≥Èó≠ÂõæÁâáÈ¢ÑËßà
onBeforeRouteLeave((to, from) => {
  if (baseStore.photoSwipe.isShow) {
    baseStore.setPhotoSwipeVisible(false);
    return false;
  }
  return true;
});
</script>

<style lang="less" scoped>
</style>